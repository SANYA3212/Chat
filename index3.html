<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>S/E Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="js/markdown-it.min.js"></script>
  <style>
    /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ */
    :root {
      --primary: #4166d5;
      --primary-hover: #365ba7;
      --sidebar-bg: #1e1f25;
      --main-bg: #1a1a1a;
      --message-user: #4166d5;  /* –¶–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
      --message-assistant: #4d4d4d;  /* –¶–≤–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ */
      --message-user-text: white;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --border-color: #333;
      --card-bg: #25262c;
      --scroll-thumb: #4a4a4a;
      --transition: all 0.3s ease;
    }

    [data-theme="light"] {
      --sidebar-bg: #f5f7fa;
      --main-bg: #ffffff;
      --message-user: #e6f2ff;
      --message-assistant: #f0f4f8;
      --message-user-text: #000000;
      --text-primary: #1a1a1a;
      --text-secondary: #666;
      --border-color: #ddd;
      --card-bg: #ffffff;
      --scroll-thumb: #c1c1c1;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI Black", "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      display: flex;
      height: 100vh;
      background-color: var(--main-bg);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
    .sidebar {
      width: 300px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 20px;
      position: relative;
      z-index: 10;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: var(--transition);
    }

    .sidebar.collapsed {
      transform: translateX(-100%);
      width: 0;
      padding: 0;
      border: none;
      box-shadow: none;
    }

    .toggle-sidebar {
      position: fixed;
      top: 20px;
      left: 300px;
      width: 40px;
      height: 40px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-left: none;
      border-radius: 0 10px 10px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      transition: var(--transition);
    }

    .sidebar.collapsed + .toggle-sidebar {
      left: 0;
    }

    .toggle-sidebar:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .header {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .header img.logo {
      display: block;
      margin: 0 auto 10px auto;
      width: 100px;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }

    .header img.logo:hover {
      transform: rotate(5deg) scale(1.05);
    }

    .header h1 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 10px;
      color: var(--text-primary);
      transition: color 0.3s ease;
    }

    .header button {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      background-color: var(--primary);
      border: none;
      border-radius: 12px;
      color: white;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: var(--transition);
    }

    .header button:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .current-model {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
      color: var(--text-secondary);
      font-size: 14px;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      padding-right: 5px;
    }

    .chat-item {
      padding: 14px;
      margin-bottom: 8px;
      background-color: var(--card-bg);
      border-radius: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border: 1px solid var(--border-color);
      opacity: 0;
      transform: translateY(10px);
      transition: var(--transition), opacity 0.3s ease, transform 0.3s ease;
    }

    .chat-item.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .chat-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .chat-item.active {
      background-color: rgba(65, 102, 213, 0.15);
      border-color: var(--primary);
    }

    .chat-item span {
      flex: 1;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-delete-btn {
      background-color: transparent;
      border: none;
      cursor: pointer;
      margin-left: 10px;
      opacity: 0.5;
      transition: var(--transition);
    }

    .chat-delete-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .chat-delete-btn img {
      width: 24px;
      height: 24px;
      transition: transform 0.3s ease;
    }

    /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
    .main {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--main-bg);
      padding: 20px;
      overflow: hidden;
      transition: var(--transition);
      background-size: cover;
      background-attachment: fixed;
    }

    .main.expanded {
      margin-left: 0;
    }

    .main.empty-chat .input-wrapper {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      transform: translateY(-50%);
    }

    .chat-window {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      background-color: transparent;
      border-radius: 16px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .drag-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed var(--border-color);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      border-radius: 16px;
      backdrop-filter: blur(5px);
    }

    .drag-overlay.active {
      display: flex;
    }

    .drag-overlay p {
      font-size: 18px;
      color: var(--text-primary);
      font-weight: bold;
    }

    .chat-content {
      width: 100%;
      padding: 20px 40px 20px 20px;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      overflow-wrap: break-word;
      word-break: break-word;
    }

    .intro-text {
      text-align: center;
      margin-bottom: 15px;
      line-height: 1.4;
      opacity: 0;
      transform: translateY(20px);
    }

    .intro-text p {
      font-size: 2em;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .message-block {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      max-width: 90%;
      padding: 16px 16px 16px 30px;
      border-radius: 16px;
      position: relative;
      overflow-wrap: break-word;
      word-break: break-word;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .message-block:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .chat-text {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .assistant-message {
      align-self: flex-start;
      background-color: var(--message-assistant);
      border: 1px solid var(--border-color);
    }

    .user-message {
      align-self: flex-end;
      background-color: var(--message-user);
      border: 1px solid var(--border-color);
      color: var(--message-user-text);
    }

    .user-message .role,
    .user-message .chat-text,
    .user-message .message-buttons button {
      color: var(--message-user-text);
    }

    .message-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      margin-left: auto;
      opacity: 0.6;
      transition: opacity 0.3s ease;
    }

    .message-block:hover .message-buttons {
      opacity: 1;
    }

    .message-copy-btn, .message-edit-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--text-primary);
      display: inline-block;
      padding: 4px;
      border-radius: 6px;
      transition: var(--transition);
    }

    .message-copy-btn:hover, .message-edit-btn:hover {
      background-color: rgba(255,255,255,0.1);
      transform: scale(1.1);
    }

    .code-container {
      position: relative;
      margin-bottom: 12px;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
      transition: transform 0.3s ease;
    }

    .code-container:hover {
      transform: scale(1.01);
    }

    .copy-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background-color: var(--card-bg);
      border: none;
      border-radius: 5px;
      color: var(--text-primary);
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
      opacity: 0.7;
      transition: var(--transition);
    }

    .copy-btn:hover {
      opacity: 1;
      background-color: var(--primary);
      color: white;
      transform: scale(1.05);
    }

    pre code {
      display: block;
      background-color: var(--sidebar-bg);
      padding: 15px;
      border-radius: 12px;
      overflow-x: auto;
      margin: 0;
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.4;
    }

    /* –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ */
    .input-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      position: relative;
    }

    #attachmentsContainer {
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
      justify-content: center;
      max-width: 80%;
    }

    #attachmentsContainer img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    #attachmentsContainer img:hover {
      transform: scale(1.05);
    }

    .attachment-preview {
      position: relative;
      display: inline-block;
      margin: 4px;
    }

    .file-preview {
      padding: 4px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
      font-size: 12px;
      background-color: var(--card-bg);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 80px;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .file-preview:hover {
      transform: translateY(-3px);
    }

    .cancel-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 16px;
      line-height: 16px;
      padding: 2px 6px;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .cancel-btn:hover {
      background: #ff4d4d;
      transform: scale(1.1);
    }

    .input-area {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 80%;
    }

    #chatInput {
      width: 100%;
      min-height: 50px;
      max-height: 200px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 25px;
      background-color: var(--card-bg);
      color: var(--text-primary);
      resize: none;
      overflow-y: auto;
      font-family: "Segoe UI Black", "Inter", sans-serif;
      line-height: 1.5;
      font-size: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: var(--transition);
    }

    #chatInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(65, 102, 213, 0.2);
      outline: none;
      transform: translateY(-2px);
    }

    .input-area button {
      border: none;
      border-radius: 50%;
      background-color: var(--primary);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      /* width: 50px; Removed */
      /* height: 50px; Removed */
      display: inline-flex; /* Changed from flex to allow content wrapping */
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: var(--transition);
      padding: 3px; /* Changed padding around the image */
      box-sizing: border-box; 
    }

    .input-area button:hover {
      background-color: var(--primary-hover);
      transform: scale(1.05);
    }

    #sendBtn,
    #stopBtn {
      background-color: transparent;
      border: none; /* Removed border */
    }

    #sendBtn:hover,
    #stopBtn:hover {
      background-color: rgba(255, 255, 255, 0.1); /* Match #imageUploadBtn hover background, no rotation */
    }

    /* Tools button styles */
    #toolsBtn {
      background-color: var(--card-bg);
      position: relative;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      border-radius: 50%; /* Ensure circular */
      /* width and height are effectively removed due to base class change */
      padding: 3px; /* Consistent padding */
      display: inline-flex; /* Ensure it wraps content */
      box-sizing: border-box; /* Ensure padding/border don't alter fixed dimensions */
    }

    #toolsBtn:hover {
      background-color: #647af7;
      border-color: #647af7;
    }

    #toolsBtn.active {
      background-color: #4166d5;
      border-color: #4166d5;
    }

    #toolsBtn.active:hover {
      background-color: #0040ff;
      border-color: #0040ff;
    }



    #imageUploadBtn {
      border: none;
      background: none;
      cursor: pointer;
      margin-right: 4px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      padding: 3px; /* Consistent padding */
      display: inline-flex; /* Ensure it wraps content */
      /* box-sizing: border-box; is inherited */
    }

    #imageUploadBtn:hover {
      background-color: rgba(255,255,255,0.1);
      transform: rotate(10deg);
    }

    .input-area button img,
    #imageUploadBtn img,
    #toolsBtn img {
      display: block; /* Helps prevent extra space if parent is inline-flex */
      /* Removed max-width, max-height, object-fit. Size will be from inline style on <img> */
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.show {
      display: block;
      opacity: 1;
    }

    .modal-content {
      background-color: var(--card-bg);
      margin: 10% auto;
      padding: 25px;
      border: 1px solid var(--border-color);
      width: 400px;
      max-width: 90%;
      border-radius: 20px;
      color: var(--text-primary);
      text-align: center;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      transform: translateY(-20px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .modal.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-content h2 {
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .close:hover {
      color: var(--primary);
      transform: scale(1.1);
    }

    #settingsModal select {
      width: 90%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background-color: var(--main-bg);
      color: var(--text-primary);
      font-size: 16px;
      transition: var(--transition);
    }

    #settingsModal select:focus {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    #saveSettingsBtn {
      margin-top: 20px;
      padding: 12px 25px;
      background-color: var(--primary);
      border: none;
      border-radius: 25px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      width: 100%;
      transition: var(--transition);
    }

    #saveSettingsBtn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-3px);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è */
    .switch input:checked + .slider {
      background-color: var(--primary);
    }

    .switch input:checked + .slider:before {
      transform: translateX(26px);
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    .model-option {
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--main-bg);
      transition: var(--transition);
    }

    .model-option:hover {
      border-color: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .model-option button {
      background-color: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-primary);
      padding: 5px 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .model-option button:hover {
      background-color: rgba(255,255,255,0.1);
      transform: scale(1.1);
    }

    .model-option button img {
      width: 40px;
      height: 40px;
    }

    .progress-container {
      position: relative;
      width: 100%;
      background-color: var(--main-bg);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 10px;
      height: 25px;
      border: 1px solid var(--border-color);
    }

    .progress-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 0;
      background-color: var(--primary);
      transition: width 0.3s ease;
    }

    .progress-label {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      line-height: 25px;
      text-align: center;
      color: #fff;
      font-size: 12px;
      pointer-events: none;
      user-select: none;
      font-weight: bold;
    }

    .custom-input {
      margin-top: 10px;
      width: 90%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background-color: var(--main-bg);
      color: var(--text-primary);
      font-size: 16px;
      transition: var(--transition);
    }

    .custom-input:focus {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .install-btn {
      margin-top: 15px;
      padding: 12px 20px;
      background-color: var(--primary);
      border: none;
      border-radius: 25px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      transition: var(--transition);
    }

    .install-btn:hover {
      background-color: var(--primary-hover);
      transform: translateY(-3px);
    }

    /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã */
    .theme-options {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      justify-content: center;
    }

    .theme-option {
      flex: 1;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      border: 2px solid transparent;
      max-width: 120px;
      transition: var(--transition);
    }

    .theme-option.active {
      border-color: var(--primary);
      background-color: rgba(65, 102, 213, 0.1);
    }

    .theme-option:hover {
      transform: scale(1.05);
    }

    .theme-dark {
      background: linear-gradient(135deg, #1e1f25, #121318);
      color: white;
    }

    .theme-light {
      background: linear-gradient(135deg, #f5f7fa, #e4e9f2);
      color: #333;
    }

    .custom-theme-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .custom-theme-inputs input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background-color: var(--main-bg);
      color: var(--text-primary);
      transition: var(--transition);
    }

    .custom-theme-inputs input:focus {
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .bg-preview {
      height: 100px;
      border-radius: 15px;
      margin-top: 15px;
      border: 1px solid var(--border-color);
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: var(--main-bg);
      transition: transform 0.3s ease;
    }

    .bg-preview:hover {
      transform: scale(1.02);
    }

    /* –ü–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--scroll-thumb);
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: content-box;
      transition: background-color 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--primary);
    }

    .chat-list, .chat-window {
      scrollbar-width: thin;
      scrollbar-color: var(--scroll-thumb) transparent;
    }
    
    .chat-window::-webkit-scrollbar {
      width: 10px;
    }
    
    .chat-window::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-window::-webkit-scrollbar-thumb {
      background-color: var(--scroll-thumb);
      border-radius: 10px;
      border: 3px solid transparent;
      background-clip: content-box;
    }
    
    .chat-window::-webkit-scrollbar-thumb:hover {
      background-color: var(--primary);
    }

@media screen and (max-width: 768px) {
  .sidebar {
    position: fixed; /* –ü–æ–≤–µ—Ä—Ö –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%); /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–∞ */
    width: 280px; /* –®–∏—Ä–∏–Ω–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
    box-shadow: 2px 0 10px rgba(0,0,0,0.2); /* –¢–µ–Ω—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
  }

  .sidebar.collapsed {
    transform: translateX(-100%);
    width: 0; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —à–∏—Ä–∏–Ω–∞ 0 –∫–æ–≥–¥–∞ collapsed */
    padding: 0;
    border: none;
    box-shadow: none;
  }

  .sidebar:not(.collapsed) {
    transform: translateX(0); /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º */
  }

  .toggle-sidebar {
    left: 10px; /* –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —É –ª–µ–≤–æ–≥–æ –∫—Ä–∞—è —Å –Ω–µ–±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º */
    background-color: rgba(var(--card-bg-rgb, 37, 38, 44), 0.8); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç */
    backdrop-filter: blur(2px);
  }

  .sidebar:not(.collapsed) + .toggle-sidebar {
    left: 290px; /* (—à–∏—Ä–∏–Ω–∞ —Å–∞–π–¥–±–∞—Ä–∞ + –æ—Ç—Å—Ç—É–ø) */
  }

  .main {
    padding: 15px 10px; /* –£–º–µ–Ω—å—à–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã */
    margin-left: 0; /* –°–∞–π–¥–±–∞—Ä —Ç–µ–ø–µ—Ä—å fixed –∏ –Ω–µ —Å–¥–≤–∏–≥–∞–µ—Ç main */
  }

  .input-area {
    max-width: 100%; /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–æ—á—Ç–∏ –≤—Å—é —à–∏—Ä–∏–Ω—É */
    padding: 0 5px;
  }
  
  .chat-content {
    padding: 10px 10px 10px 15px; /* –£–º–µ–Ω—å—à–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã —É —Å–æ–æ–±—â–µ–Ω–∏–π */
  }

  .message-block {
    max-width: 100%; /* –°–æ–æ–±—â–µ–Ω–∏—è –º–æ–≥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –≤—Å—é —à–∏—Ä–∏–Ω—É */
    padding: 10px 12px 10px 15px;
    font-size: 0.95em;
  }
  
  .modal-content {
    margin: 10% auto; /* –£–º–µ–Ω—å—à–∏—Ç—å –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø –¥–ª—è –º–æ–¥–∞–ª–æ–∫ */
    padding: 20px;
    width: 90%; /* –ú–æ–¥–∞–ª–∫–∏ —à–∏—Ä–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
  }

  .header h1 {
    font-size: 20px;
  }
  .header button {
    padding: 10px;
    font-size: 0.9em;
  }
  .chat-item {
    padding: 10px;
  }
  .chat-item span {
    font-size: 0.9em;
  }

  /* –ß—Ç–æ–±—ã —Ç–µ–ª–æ –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª–æ—Å—å, –∫–æ–≥–¥–∞ —Å–∞–π–¥–±–∞—Ä –æ—Ç–∫—Ä—ã—Ç (–µ—Å–ª–∏ –æ–Ω –ø–æ–≤–µ—Ä—Ö) */
  body.sidebar-open-mobile .main {
    /* –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
    /* filter: blur(2px); */ 
  }
}

@media screen and (max-width: 480px) {
  #chatInput {
    font-size: 15px;
    padding: 12px 15px;
  }
  .input-area button {
    width: 48px;
    height: 48px;
  }
  .input-area button img {
    width: 22px;
    height: 22px;
  }
  .header img.logo {
      width: 70px;
      margin-bottom: 5px;
  }
  .header h1 {
    font-size: 18px;
    margin-bottom: 5px;
  }
  .header button {
    margin-bottom: 8px;
    padding: 8px;
  }
  .sidebar {
    padding: 15px;
    width: 260px; /* –ß—É—Ç—å —É–∂–µ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
  }
  .sidebar:not(.collapsed) + .toggle-sidebar {
    left: 270px; 
  }
  #sidebarModelInstallProgressContainer {
    font-size: 0.9em;
  }
}
  </style>
  <link rel="stylesheet" id="highlight-light-theme" href="js/highlightjs/default-light.min.css" media="all" disabled>
  <link rel="stylesheet" id="highlight-dark-theme" href="js/highlightjs/default-dark.min.css" media="all" disabled>
  
  <!-- MathJax Configuration -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  <!-- Local MathJax files for offline use -->
  <script src="mathjax-offline/polyfill.min.js"></script>
  <script id="MathJax-script" async src="mathjax-offline/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å (—Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤) -->
  <div class="sidebar" id="sidebar">
    <div class="header">
      <img src="icon/logo.png" alt="Logo" class="logo">
      <h1 id="headerTitle">S/E Chat</h1>
      <div class="current-model" id="currentModelDisplay">...</div>
      <button id="newChat">
        <img src="icon/plus.png" alt="New Chat" style="width:28px;height:28px;">
        New Chat
      </button>
      <button id="changeModel">
        <img src="icon/model.png" alt="Change Model" style="width:28px;height:28px;">
        Change Model
      </button>
      <button id="openSettings">
        <img src="icon/settings.png" alt="Settings" style="width:28px;height:28px;">
        Settings
      </button>
    </div>
    <div id="sidebarModelInstallProgressContainer" style="display:none; margin-top: 15px; padding: 10px; background-color: var(--card-bg); border-radius: 8px; text-align: center;">
      <div id="sidebarProgressLabel" style="font-size: 0.9em; margin-bottom: 5px; color: var(--text-secondary);">Installing model...</div>
      <div class="progress-container" style="height: 10px; background-color: var(--main-bg);">
        <div id="sidebarProgressFill" class="progress-fill" style="width: 0%; height: 100%;"></div> 
      </div>
      <div id="sidebarProgressText" style="font-size: 0.8em; color: var(--text-secondary); margin-top: 3px;">0%</div>
    </div>
    <div class="chat-list" id="chatList"></div>
  </div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ -->
  <div class="toggle-sidebar" id="toggleSidebar">‚óÄ</div>
  
  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
  <div class="main" id="mainContent">
    <div class="chat-window" id="chatWindow">
      <div class="drag-overlay" id="dragOverlay">
        <p>Drop files here</p>
      </div>
      <div class="chat-content" id="chatContent"></div>
    </div>
    <div class="input-wrapper">
      <div class="intro-text" id="introText">
        <p id="introTitle">Hi, I'm S/E Chat</p>
        <p id="introSubtitle">How can I help you todayüòä?</p>
      </div>
      <div id="attachmentsContainer"></div>
      <div class="input-area">
        <button id="imageUploadBtn" title="Attach file">
          <img src="icon/attach-file.png" alt="Attach file" style="width:65px;height:65px;">
        </button>
        <button id="toolsBtn" title="Toggle Tools">
          <img src="icon/tools.png" alt="Tools" style="width:43px;height:43px;">
        </button>
        <input type="file" id="fileInput" multiple style="display: none;">
        <textarea id="chatInput" placeholder="Enter message..."></textarea>
        <button id="sendBtn" class="send-btn">
          <img src="icon/send.png" alt="Send" style="width:50px;height:50px;">
        </button>
        <button id="stopBtn" style="display:none;">
          <img src="icon/stop.png" alt="Stop" style="width:50px;height:50px;">
        </button>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ -->
  <div id="modelModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModelModal" title="Close">&times;</span>
      <h2 id="modelModalTitle">Change Model</h2>
      <div id="modelOptionsContainer"></div>
      <div id="modelCustomContainer"></div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeSettingsModal" title="Close">&times;</span>
      <h2 id="settingsModalTitle">Settings</h2>
      <div>
        <label for="languageSelect" id="languageLabel">Language:</label>
        <select id="languageSelect">
          <option value="en">English</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
        </select>
      </div>
      <div style="margin-top:15px;">
        <label for="defaultModelSelect" id="defaultModelLabel">Default Model:</label>
        <select id="defaultModelSelect"></select>
      </div>

      <div style="margin-top:15px;">
        <label for="modelTemperatureInput" id="modelTemperatureLabel">Model Temperature:</label>
        <div style="display: flex; align-items: center; gap: 10px; width: 90%; margin-top: 8px;">
          <input type="range" id="modelTemperatureInput" min="0" max="2" step="0.05" style="flex-grow: 1; height: 20px;">
          <span id="modelTemperatureValueSpan" style="min-width: 30px; text-align: right;">0.8</span>
        </div>
      </div>
      
      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–º—ã -->
      <div style="margin-top:20px;">
        <label id="themeLabel">Theme:</label>
        <div class="theme-options">
          <div class="theme-option theme-dark active" data-theme="dark">Dark</div>
          <div class="theme-option theme-light" data-theme="light">Light</div>
        </div>
      </div>
      
      <div style="margin-top:20px;">
        <label id="backgroundLabel">Background:</label>
        <div class="custom-theme-inputs">
          <input type="file" id="bgImageInput" accept="image/*" style="display:none;">
          <button id="uploadBgBtn">Upload Image</button>
          <button id="resetBgBtn">Reset</button>
        </div>
        
        <div class="bg-preview" id="bgPreview">
          <span id="bgPreviewText">No background</span>
        </div>
      </div>
      
      <div style="margin-top:20px;">
        <label>Custom Gradient:</label>
        <div class="custom-theme-inputs">
          <input type="color" id="gradientColor1" value="#4166d5">
          <input type="color" id="gradientColor2" value="#1e1f25">
        </div>
        <button id="applyGradientBtn" style="width:100%; margin-top:10px;">Apply Gradient</button>
      </div>
      
      
      <button id="saveSettingsBtn">Save Settings</button>
    </div>
  </div>
  
  <script src="js/highlightjs/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script>
    var markdown = window.markdownit({
      html: false,
      linkify: true,
      typographer: true,
      breaks: true
    });
    markdown.toHTML = markdown.render;
    const message = ``;
  </script>
  
  <script type="module">
    import { fetchGeneratedTitle } from './js/titleHandler.js';
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let currentModel = "";
    let streamAbortController = null;
    let editingIndex = null;
    let currentTheme = "dark";
    let toolsEnabled = false;
    let isModelInstalling = false;
    let currentInstallingModelName = null;
    let globalInstallPercent = 0;
    let isGeneratingTitle = false;

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function applyHighlightTheme(theme) {
      const lightThemeLink = document.getElementById('highlight-light-theme');
      const darkThemeLink = document.getElementById('highlight-dark-theme');

      if (!lightThemeLink || !darkThemeLink) {
        console.error('Highlight.js theme link elements not found!');
        return;
      }

      if (theme === 'light') {
        lightThemeLink.removeAttribute('disabled');
        darkThemeLink.setAttribute('disabled', 'disabled');
      } else { // Default to dark theme
        darkThemeLink.removeAttribute('disabled');
        lightThemeLink.setAttribute('disabled', 'disabled');
      }
    }

    // --- –≠–õ–ï–ú–ï–ù–¢–´ –°–¢–†–ê–ù–ò–¶–´ ---
    const newChatBtn = document.getElementById("newChat");
    const changeModelBtn = document.getElementById("changeModel");
    const openSettingsBtn = document.getElementById("openSettings");
    const closeModelModal = document.getElementById("closeModelModal");
    const closeSettingsModal = document.getElementById("closeSettingsModal");
    const chatInput = document.getElementById("chatInput");
    const fileInput = document.getElementById("fileInput");
    const sendBtn = document.getElementById("sendBtn");
    const stopBtn = document.getElementById("stopBtn");
    const toolsBtn = document.getElementById("toolsBtn");
    const chatList = document.getElementById("chatList");
    const chatContent = document.getElementById("chatContent");
    const dragOverlay = document.getElementById("dragOverlay");
    const imageUploadBtn = document.getElementById("imageUploadBtn");
    const languageSelect = document.getElementById("languageSelect");
    const defaultModelSelect = document.getElementById("defaultModelSelect");
    const currentModelDisplay = document.getElementById("currentModelDisplay");
    const settingsModal = document.getElementById("settingsModal");
    const modelModal = document.getElementById("modelModal");
    const modelOptionsContainer = document.getElementById("modelOptionsContainer");
    const modelCustomContainer = document.getElementById("modelCustomContainer");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const attachmentsContainer = document.getElementById("attachmentsContainer");
    const introText = document.getElementById("introText");
    const introTitleEl = document.getElementById("introTitle");
    const introSubtitleEl = document.getElementById("introSubtitle");
    const toggleSidebar = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    const bgImageInput = document.getElementById("bgImageInput");
    const uploadBgBtn = document.getElementById("uploadBgBtn");
    const resetBgBtn = document.getElementById("resetBgBtn");
    const bgPreview = document.getElementById("bgPreview");
    const bgPreviewText = document.getElementById("bgPreviewText");
    const gradientColor1 = document.getElementById("gradientColor1");
    const gradientColor2 = document.getElementById("gradientColor2");
    const applyGradientBtn = document.getElementById("applyGradientBtn");
    const mainContent = document.getElementById("mainContent");
    const modelTemperatureInput = document.getElementById("modelTemperatureInput");
    const modelTemperatureValueSpan = document.getElementById("modelTemperatureValueSpan");

    const sidebarModelInstallProgressContainer = document.getElementById("sidebarModelInstallProgressContainer");
    const sidebarProgressLabel = document.getElementById("sidebarProgressLabel");
    const sidebarProgressFill = document.getElementById("sidebarProgressFill");
    const sidebarProgressText = document.getElementById("sidebarProgressText");

    let imageFilesBase64 = [];
    let imageFiles = [];
    let fileAttachments = [];

    // --- –ü–ï–†–ï–í–û–î–´ ---
    const translations = {
      en: {
        headerTitle: "S/E Chat",
        currentModel: "Current Model: ",
        newChat: "New Chat",
        changeModel: "Change Model",
        settings: "Settings",
        send: "Send",
        stop: "Stop",
        languageLabel: "Language:",
        defaultModelLabel: "Default Model:",
        modelTemperatureLabel: "Model Temperature:",
        modelModalTitle: "Change Model",
        settingsModalTitle: "Settings",
        saveSettings: "Save Settings",
        deleteBtn: "Delete",
        inputPlaceholder: "Enter message...",
        copyBtn: "Copy",
        copiedBtn: "Copied!",
        attachFile: "Attach file",
        copyUserMessage: "Copy message",
        copyAssistantMessage: "Copy answer",
        dropFilesHere: "Drop files here",
        customModel: "Add Model",
        installModel: "Install Model",
        close: "Close",
        newChatTitle: "New Chat",
        introTitle: "Hi, I'm S/E Chat",
        introSubtitle: "How can I help you todayüòä?",
        themeLabel: "Theme:",
        backgroundLabel: "Background:",
        inputPlaceholderGeneratingTitle: "Generating chat title, please wait...",
      },
      ru: {
        headerTitle: "S/E –ß–∞—Ç",
        currentModel: "–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å: ",
        newChat: "–ù–æ–≤—ã–π —á–∞—Ç",
        changeModel: "–°–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å",
        settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        send: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
        stop: "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
        languageLabel: "–Ø–∑—ã–∫:",
        defaultModelLabel: "–ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:",
        modelTemperatureLabel: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –º–æ–¥–µ–ª–∏:",
        modelModalTitle: "–°–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å",
        settingsModalTitle: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
        saveSettings: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏",
        deleteBtn: "–£–¥–∞–ª–∏—Ç—å",
        inputPlaceholder: "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...",
        copyBtn: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
        copiedBtn: "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
        attachFile: "–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª",
        copyUserMessage: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ",
        copyAssistantMessage: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç",
        dropFilesHere: "–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞",
        customModel: "–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å",
        installModel: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
        close: "–ó–∞–∫—Ä—ã—Ç—å",
        newChatTitle: "–ù–æ–≤—ã–π —á–∞—Ç",
        introTitle: "–ü—Ä–∏–≤–µ—Ç, —è S/E –ß–∞—Ç",
        introSubtitle: "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—åüòä?",
        themeLabel: "–¢–µ–º–∞:",
        backgroundLabel: "–§–æ–Ω:",
        inputPlaceholderGeneratingTitle: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ...",
      }
    };

    function updateInterfaceLanguage(lang) {
      document.getElementById("headerTitle").textContent = translations[lang].headerTitle;
      newChatBtn.innerHTML = `<img src="icon/plus.png" alt="New Chat" style="width:28px;height:28px;"> ${translations[lang].newChat}`;
      changeModelBtn.innerHTML = `<img src="icon/model.png" alt="Change Model" style="width:28px;height:28px;"> ${translations[lang].changeModel}`;
      openSettingsBtn.innerHTML = `<img src="icon/settings.png" alt="Settings" style="width:28px;height:28px;"> ${translations[lang].settings}`;
      chatInput.placeholder = translations[lang].inputPlaceholder;
      introTitleEl.textContent = translations[lang].introTitle;
      introSubtitleEl.textContent = translations[lang].introSubtitle;
      document.getElementById("settingsModalTitle").textContent = translations[lang].settingsModalTitle;
      document.getElementById("languageLabel").textContent = translations[lang].languageLabel;
      document.getElementById("defaultModelLabel").textContent = translations[lang].defaultModelLabel;
      document.getElementById("modelTemperatureLabel").textContent = translations[lang].modelTemperatureLabel;
      saveSettingsBtn.textContent = translations[lang].saveSettings;
      document.getElementById("modelModalTitle").textContent = translations[lang].modelModalTitle;
      dragOverlay.querySelector('p').textContent = translations[lang].dropFilesHere;
      imageUploadBtn.title = translations[lang].attachFile;
      closeModelModal.title = translations[lang].close;
      closeSettingsModal.title = translations[lang].close;
      currentModelDisplay.textContent = translations[lang].currentModel + (currentModel || "‚Äî");
      document.getElementById("themeLabel").textContent = translations[lang].themeLabel;
      document.getElementById("backgroundLabel").textContent = translations[lang].backgroundLabel;
      uploadBgBtn.textContent = translations[lang].installModel;
      resetBgBtn.textContent = translations[lang].deleteBtn;
    }

    function autoResize() {
      chatInput.style.height = 'auto';
      const maxHeight = 200;
      chatInput.style.height = Math.min(chatInput.scrollHeight, maxHeight) + 'px';
    }

    window.copyMessageContent = function(btn) {
      const messageBlock = btn.closest('.message-block');
      if (!messageBlock) return;
      const texts = Array.from(messageBlock.querySelectorAll('.chat-text'))
                        .map(el => el.innerText)
                        .join("\n");
      navigator.clipboard.writeText(texts).then(() => {
        const lang = languageSelect.value;
        const oldHTML = btn.innerHTML;
        btn.innerHTML = `<img src="icon/copy.png" alt="Copy" style="width:24px; height:24px;"> ${translations[lang].copiedBtn}`;
        setTimeout(() => {
          btn.innerHTML = oldHTML;
        }, 1500);
      });
    }
    
    window.copyCode = function(btn) {
      const codeElement = btn.parentElement.querySelector('code');
      if (!codeElement) return;
      const codeText = codeElement.textContent;
      navigator.clipboard.writeText(codeText).then(() => {
        const lang = languageSelect.value;
        const oldHTML = btn.innerHTML;
        btn.innerHTML = translations[lang].copiedBtn;
        setTimeout(() => {
          btn.innerHTML = oldHTML;
        }, 1500);
      });
    }
    
    window.editUserMessage = function(btn) {
      const messageBlock = btn.closest('.message-block');
      if (!messageBlock) return;
      const chatTextElement = messageBlock.querySelector('.chat-text');
      if (!chatTextElement) return;
      const originalText = chatTextElement.innerText.trim();
      const chat = chats.find(c => c.id === activeChatId);
      if (!chat) return;
      const msgIndex = chat.history.findIndex(m =>
        m.role.toLowerCase() === "user" &&
        (m.display || "").trim() === originalText
      );
      if (msgIndex === -1) return;
      chat.history = chat.history.slice(0, msgIndex + 1);
      editingIndex = msgIndex;
      chatInput.value = originalText;
      autoResize();
      updateChatWindow();
      chatInput.focus();
    }
    
    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
    
    function parseContentForCodeBlocks(content, modelNameForMessage = '') {
      content = content.replace(/<(?:think|thought)>[\s\S]*?<\/(?:think|thought)>/gi, "");
      const parts = content.split("```");
      let isCode = false;
      let result = "";
      for (let i = 0; i < parts.length; i++) {
        let segment = parts[i];
        if (!isCode) {
          // >>> –ù–ê–ß–ê–õ–û –ö–û–°–¢–´–õ–Ø –î–õ–Ø DEEPSEEK MATHJAX
          let isDeepseekModel = false;
          if (modelNameForMessage && modelNameForMessage.toLowerCase().includes("deepseek")) {
            isDeepseekModel = true;
          }
          // Note: The original request had a more complex way to find messageObject or use currentModel.
          // Since modelNameForMessage is now directly passed, this simplifies.
          // If modelNameForMessage is empty, isDeepseekModel remains false.

          if (isDeepseekModel) {
            console.log('[MathJaxDebug] Deepseek model detected, applying MathJax content fixes for [] and [[]]. Segment before fix:', segment);
            // –ö–æ—Å—Ç—ã–ª—å –¥–ª—è –æ–¥–∏–Ω–∞—Ä–Ω—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ–∫ [formula] -> $formula$
            // –ò—â–µ—Ç [—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ_—Å_–º–∞—Ç_—Å–∏–º–≤–æ–ª–∞–º–∏_–±–µ–∑_–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö_—Å–∫–æ–±–æ–∫_–∏_–¥–æ–ª–ª–∞—Ä–æ–≤] –ù–ï –ó–ê –ö–û–¢–û–†–´–ú –°–õ–ï–î–£–ï–¢ '('
            segment = segment.replace(/\[((?:[^\$\(\)\[\]]|\[(?:\^|\_|[a-zA-Z0-9]))*?[\^_a-zA-Z0-9\\](?:[^\$\(\)\[\]]|\[(?:\^|\_|[a-zA-Z0-9]))*?)\](?!\s*\()/g, (match, p1) => {
              if (p1.includes('$')) return match;
              if (/[\^_\{\}]|(?:\b(?:frac|sqrt|sum|int|lim|alpha|beta|gamma|delta|theta|lambda|mu|pi|sigma|omega|infty|pm|times|div|approx|neq|leq|geq|equiv|forall|exists|nabla|partial)\b)/.test(p1)) {
                console.log(`[MathJaxDebug] Deepseek-–∫–æ—Å—Ç—ã–ª—å (single_bracket): [${p1}] -> $${p1}$`);
                return `$${p1}$`;
              }
              return match; 
            });

            // –ö–æ—Å—Ç—ã–ª—å –¥–ª—è –¥–≤–æ–π–Ω—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–æ–∫ [[formula]] -> $$formula$$
            segment = segment.replace(/\[\[((?:[^\$\(\)\[\]]|\[(?:\^|\_|[a-zA-Z0-9]))*?[\^_a-zA-Z0-9\\](?:[^\$\(\)\[\]]|\[(?:\^|\_|[a-zA-Z0-9]))*?)\]\](?!\s*\()/g, (match, p1) => {
              if (p1.includes('$')) return match;
              if (/[\^_\{\}]|(?:\b(?:frac|sqrt|sum|int|lim|alpha|beta|gamma|delta|theta|lambda|mu|pi|sigma|omega|infty|pm|times|div|approx|neq|leq|geq|equiv|forall|exists|nabla|partial)\b)/.test(p1)) {
                console.log(`[MathJaxDebug] Deepseek-–∫–æ—Å—Ç—ã–ª—å (double_bracket): [[${p1}]] -> $$${p1}$$`);
                return `$$${p1}$$`;
              }
              return match;
            });
            console.log('[MathJaxDebug] Segment after fix:', segment);
          }
          // <<< –ö–û–ù–ï–¶ –ö–û–°–¢–´–õ–Ø –î–õ–Ø DEEPSEEK MATHJAX

          let rendered = window.markdown.render(segment.trim());
          result += `<div class="chat-text">${rendered}</div>`;
        } else {
          let escapedCode = escapeHtml(segment);
          result += `
            <div class="code-container">
              <button class="copy-btn" onclick="copyCode(this)">
                <img src="icon/copy.png" alt="Copy" style="width:24px; height:24px;">
              </button>
              <pre><code>${escapedCode}</code></pre>
            </div>
          `;
        }
        isCode = !isCode;
      }
      return result;
    }
    
    function updateAttachmentsPreview() {
      attachmentsContainer.innerHTML = "";
      imageFiles.forEach((item, index) => {
        const preview = document.createElement("div");
        preview.className = "attachment-preview";
        const img = document.createElement("img");
        img.src = item.data;
        img.loading = "lazy";
        preview.appendChild(img);
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "cancel-btn";
        cancelBtn.innerHTML = "√ó";
        cancelBtn.addEventListener("click", () => {
          imageFiles.splice(index, 1);
          imageFilesBase64.splice(index, 1);
          updateAttachmentsPreview();
        });
        preview.appendChild(cancelBtn);
        attachmentsContainer.appendChild(preview);
      });
      fileAttachments.forEach((item, index) => {
        const preview = document.createElement("div");
        preview.className = "attachment-preview file-preview";
        const iconImg = document.createElement("img");
        iconImg.src = "icon/file.png";
        iconImg.style.width = "40px";
        iconImg.style.height = "40px";
        iconImg.style.objectFit = "contain";
        preview.appendChild(iconImg);
        const fileNameSpan = document.createElement("span");
        fileNameSpan.textContent = item.name;
        preview.appendChild(fileNameSpan);
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "cancel-btn";
        cancelBtn.innerHTML = "√ó";
        cancelBtn.addEventListener("click", () => {
          fileAttachments.splice(index, 1);
          updateAttachmentsPreview();
        });
        preview.appendChild(cancelBtn);
        attachmentsContainer.appendChild(preview);
      });
      attachmentsContainer.style.display =
        (imageFiles.length === 0 && fileAttachments.length === 0) ? "none" : "flex";
    }
    
    function handleDroppedFiles(files) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
          const blobUrl = URL.createObjectURL(file);
          imageFiles.push({ data: blobUrl, name: file.name });
          const reader = new FileReader();
          reader.onload = (e) => {
            const dataUrl = e.target.result;
            const base64 = dataUrl.split(',')[1];
            imageFilesBase64.push(base64);
            updateAttachmentsPreview();
          };
          reader.readAsDataURL(file);
        }
      }
    }
    
    function handleNonImageFiles(files) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const textContent = e.target.result;
            fileAttachments.push({ name: file.name, content: textContent });
            updateAttachmentsPreview();
          };
          reader.readAsText(file);
        }
      }
    }
    
    let chats = [];
    let activeChatId = null;
    let chatIdCounter = 0;
    let defaultSettings;
    
    function getTruncatedTitle(chat) {
      const lang = languageSelect.value;
      // –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω AI (chat.titleGenerated === true) 
      // –∏ –æ–Ω –Ω–µ –ø—É—Å—Ç–æ–π (chat.chatnamess) –∏ –Ω–µ —Ä–∞–≤–µ–Ω –¥–µ—Ñ–æ–ª—Ç–Ω–æ–º—É (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å –∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥–µ—Ñ–æ–ª—Ç)
      if (chat.titleGenerated && chat.chatnamess && chat.chatnamess !== translations[lang].newChatTitle) {
        return chat.chatnamess; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º AI-—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∫ –µ—Å—Ç—å (—Å–µ—Ä–≤–µ—Ä –µ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–∏–ª ~100 —Å–∏–º–≤–æ–ª–∞–º–∏)
      }

      // –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ, –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –æ–±—Ä–µ–∑–∫–∏)
      for (let msg of chat.history) {
        if (msg.role && msg.role.toLowerCase() === "user" && msg.display) {
          return msg.display.trim(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        }
      }
      
      // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
      // –∏–ª–∏ –µ—Å–ª–∏ chat.chatnamess –≤—Å–µ –µ—â–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π.
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º chat.chatnamess –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∞—Ä—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ titleGenerated), –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π.
      return chat.chatnamess || translations[lang].newChatTitle;
    }
    
    function updateChatWindow() {
      const chat = chats.find(c => c.id === activeChatId);
      if (!chat) {
        chatContent.innerHTML = "";
        updateInputPosition();
        return;
      }
      if (chat.history.length === 0) {
        chatContent.innerHTML = "";
        updateInputPosition();
        return;
      }
      let html = "";
      const truncatedTitle = getTruncatedTitle(chat);
      const currentChatModel = (chat.modelhs && chat.modelhs.length > 0) ? chat.modelhs[chat.modelhs.length - 1] : currentModel;
      const lang = languageSelect.value;
      html += `<p style="margin-bottom:20px; color:var(--text-secondary);"><strong>${truncatedTitle}</strong> (${translations[lang].currentModel}${currentChatModel})</p>`;
      chat.history.forEach(m => {
        let role = m.role || "unknown";
        let displayedRole = role;
        
        if (role.toLowerCase() === "assistant") {
          let usedModel = m.modelUsed ? m.modelUsed : currentChatModel;
          displayedRole = `assistant (${usedModel})`;
        } else if (role.toLowerCase() === "user") {
          displayedRole = "user";
        }
        let contentHTML = "";
        if (role.toLowerCase() === "user" && m.display) {
          contentHTML = `<div class="chat-text">${escapeHtml(m.display)}</div>`;
        } else {
          contentHTML = parseContentForCodeBlocks(m.content || "", m.modelUsed || currentModel);
        }
        if (m.images && Array.isArray(m.images)) {
          m.images.forEach((imgData) => {
            let mimeType = "image/png";
            if (imgData.startsWith("/9j")) mimeType = "image/jpeg";
            else if (imgData.startsWith("R0lGOD")) mimeType = "image/gif";
            else if (imgData.startsWith("AAAB")) mimeType = "image/x-icon";
            contentHTML += `<div style="margin-top:15px;"><img loading="lazy" src="data:${mimeType};base64,${imgData}" style="max-width:300px; border-radius:8px; border:1px solid var(--border-color);"></div>`;
          });
        }
        if (m.files && Array.isArray(m.files)) {
          m.files.forEach(file => {
            contentHTML += `
              <div class="file-preview" style="display:inline-block; margin-top:15px; padding:8px; border-radius:10px; background-color:var(--card-bg);">
                <img src="icon/file.png" alt="File" style="width:40px; height:40px; object-fit:contain;">
                <span>${file.name}</span>
              </div>
            `;
          });
        }
        const copyTitle = (role.toLowerCase() === "assistant")
          ? translations[lang].copyAssistantMessage
          : translations[lang].copyUserMessage;
        let buttonsHTML = `
          <button class="message-copy-btn" onclick="copyMessageContent(this)" title="${copyTitle}">
            <img src="icon/copy.png" alt="Copy" style="width:24px; height:24px;">
          </button>
        `;
        if (role.toLowerCase() === "user") {
          buttonsHTML += `
            <button class="message-edit-btn" onclick="editUserMessage(this)" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
              <img src="icon/edit.png" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" style="width:24px; height:24px;">
            </button>
          `;
        }
        html += `
          <div class="message-block ${role.toLowerCase() === "assistant" ? "assistant-message" : (role.toLowerCase() === "user" ? "user-message" : "other-message")}">
            <div class="role">${displayedRole}:</div>
            ${contentHTML}
            <div class="message-buttons">
              ${buttonsHTML}
            </div>
          </div>
        `;
      });
      chatContent.innerHTML = html;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º MathJax –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise([chatContent])
          .catch((err) => {
            console.error('MathJax typeset failed:', err.message);
          });
      } else if (chatContent.innerText.includes('$')) { // –ü—Ä–æ—Å—Ç–æ–µ —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ
         console.warn('MathJax or typesetPromise not available on window, but $ symbols detected.');
      }

    // Add this for highlight.js
    if (window.hljs) {
      hljs.highlightAll();
    }
      
      updateInputPosition();
    }
    
    function updateInputPosition() {
      const mainEl = document.querySelector('.main');
      const chat = chats.find(c => c.id === activeChatId);
      if (!chat || chat.history.length === 0) {
        mainEl.classList.add('empty-chat');
        introText.style.display = "block";
        setTimeout(() => {
          introText.style.opacity = "1";
          introText.style.transform = "translateY(0)";
        }, 100);
      } else {
        mainEl.classList.remove('empty-chat');
        introText.style.display = "none";
      }
    }
    
    function updateChatItemText(chatData) {
      if (chatData.itemElement) {
        const lang = languageSelect.value;
        const truncatedTitle = getTruncatedTitle(chatData);
        const currentChatModel = (chatData.modelhs && chatData.modelhs.length > 0) ? chatData.modelhs[chatData.modelhs.length - 1] : currentModel;
        chatData.itemElement.innerHTML = `<span>${truncatedTitle} (${translations[lang].currentModel}${currentChatModel})</span>`;
        if (!chatData.itemElement.querySelector('.chat-delete-btn')) {
          const delBtn = document.createElement("button");
          delBtn.classList.add("chat-delete-btn");
          delBtn.setAttribute('title', translations[lang].deleteBtn);
          delBtn.innerHTML = `<img src="icon/delete.png" alt="${translations[lang].deleteBtn}" style="width:24px;height:24px;">`;
          delBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            deleteChat(chatData.id);
          });
          chatData.itemElement.appendChild(delBtn);
        }
      }
    }
    
    async function loadChats() {
      try {
        const response = await fetch("/chats");
        const chatIDs = await response.json();
        for (const id of chatIDs) {
          const res = await fetch(`/chats/${id}`);
          const chatData = await res.json();
          chats.push(chatData);
          addChatToList(chatData);
          chatIdCounter = Math.max(chatIdCounter, parseInt(chatData.id) + 1);
        }
      } catch (error) {
        console.error("Error loading chats:", error);
      }
    }
    
    async function saveChat(chat) {
      try {
        const res = await fetch(`/chats/${chat.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(chat)
        });
        await res.json();
        updateChatItemText(chat);
      } catch (error) {
        console.error("Error saving chat:", error);
      }
    }
    
    async function deleteChat(chatId) {
      try {
        const response = await fetch(`/delete-chat/${chatId}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.status === "success") {
          chats = chats.filter(c => c.id !== chatId);
          const item = document.querySelector(`.chat-item[data-chat-id='${chatId}']`);
          if (item) item.remove();
          if (activeChatId === chatId) {
            activeChatId = null;
            chatContent.innerHTML = "";
            updateInputPosition();
          }
        } else {
          alert("Failed to delete chat");
        }
      } catch (error) {
        console.error("Error deleting chat:", error);
      }
    }
    
    function addChatToList(chatData) {
      const chatItem = document.createElement('div');
      chatItem.classList.add('chat-item');
      chatItem.setAttribute("data-chat-id", chatData.id);
      chatData.itemElement = chatItem;
      updateChatItemText(chatData);
      chatItem.addEventListener('click', () => switchChat(chatData.id));
      chatList.insertBefore(chatItem, chatList.firstChild);
      
      // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
      setTimeout(() => {
        chatItem.classList.add('visible');
      }, 10);
    }
    
    function switchChat(chatId) {
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      activeChatId = chatId;
      const chatItem = document.querySelector(`.chat-item[data-chat-id='${chatId}']`);
      if (chatItem) chatItem.classList.add('active');
      updateChatWindow();
    }
    
    async function createNewChat() {
      document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
      const lang = languageSelect.value;
      const chat = {
        id: chatIdCounter.toString(),
        chatnamess: translations[lang].newChatTitle,
        history: [],
        modelhs: [currentModel]
      };
      chats.push(chat);
      addChatToList(chat);
      activeChatId = chat.id;
      updateChatWindow();
      await saveChat(chat);
      chatIdCounter++;
    }
    
    async function saveSettings() {
      const newSettings = {
        language: languageSelect.value,
        default_model: defaultModelSelect.value,
        model_temperature: parseFloat(modelTemperatureInput.value),
        background: {
          type: localStorage.getItem('backgroundType') || 'none',
          image: localStorage.getItem('backgroundImage') || null,
          gradient: {
            color1: localStorage.getItem('gradientColor1') || '#4166d5',
            color2: localStorage.getItem('gradientColor2') || '#1e1f25'
          }
        }
      };
      try {
        const response = await fetch("/settings", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newSettings)
        });
        const data = await response.json();
        if (data.status === "success") {
          defaultSettings = newSettings;
          currentModel = newSettings.default_model;
          currentModelDisplay.textContent = translations[languageSelect.value].currentModel + currentModel;
          const chat = chats.find(c => c.id === activeChatId);
          if (chat) {
            chat.modelhs.push(currentModel);
            updateChatWindow();
            await saveChat(chat);
          }
          updateInterfaceLanguage(languageSelect.value);
          settingsModal.classList.remove('show');
          setTimeout(() => {
            settingsModal.style.display = 'none';
          }, 300);
        } else {
          alert("Failed to save settings");
        }
      } catch (error) {
        console.error("Error saving settings:", error);
      }
    }
    
    async function loadSettings() {
      try {
        const response = await fetch("/settings", { cache: "no-cache" });
        const settingsData = await response.json();
        defaultSettings = settingsData;
        languageSelect.value = settingsData.language || "en";
        currentModel = settingsData.default_model || "";
        await loadInstalledModelsForSettings(); // This ensures defaultModelSelect is populated
        defaultModelSelect.value = settingsData.default_model || ""; // Set the value after options are loaded
        modelTemperatureInput.value = settingsData.model_temperature !== undefined ? settingsData.model_temperature : 0.8;
        if (modelTemperatureValueSpan) modelTemperatureValueSpan.textContent = parseFloat(modelTemperatureInput.value).toFixed(2);
        updateInterfaceLanguage(languageSelect.value);
        
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        currentTheme = savedTheme; // Ensure currentTheme is updated
        applyHighlightTheme(currentTheme);
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        if (settingsData.background) {
          const bg = settingsData.background;
          localStorage.setItem('backgroundType', bg.type || 'none');
          if (bg.type === 'image' && bg.image) {
            localStorage.setItem('backgroundImage', bg.image);
          } else if (bg.type === 'gradient') {
            localStorage.setItem('gradientColor1', bg.gradient.color1);
            localStorage.setItem('gradientColor2', bg.gradient.color2);
          }
        }
        
        updateBackgroundPreview();
        applyBackground();
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        // automaticToolsToggle.checked = settingsData.automatic_tools || false; // –£–¥–∞–ª–µ–Ω–æ
        // toolsEnabled = automaticToolsToggle.checked; // –£–¥–∞–ª–µ–Ω–æ, toolsEnabled –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ false –≥–ª–æ–±–∞–ª—å–Ω–æ
        toolsBtn.classList.toggle('active', toolsEnabled); // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –æ—Ç—Ä–∞–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ toolsEnabled (false)
        
      } catch (error) {
        console.error("Error loading settings:", error);
      }
    }
    
    async function loadInstalledModelsForSettings() {
      try {
        const response = await fetch("/installed-models");
        const models = await response.json();
        defaultModelSelect.innerHTML = "";
        models.forEach(model => {
          const opt = document.createElement("option");
          opt.value = model;
          opt.textContent = model;
          defaultModelSelect.appendChild(opt);
        });
        defaultModelSelect.value = defaultSettings.default_model || "";
        currentModelDisplay.textContent = translations[languageSelect.value].currentModel + (currentModel || "‚Äî");
      } catch (error) {
        console.error("Error loading models for settings:", error);
      }
    }
    
    async function changeModel(model) {
      try {
        const resp = await fetch("/switch-model", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model })
        });
        const data = await resp.json();
        if (data.status === "success") {
          currentModel = model;
          currentModelDisplay.textContent = translations[languageSelect.value].currentModel + currentModel;
          const chat = chats.find(c => c.id === activeChatId);
          if (chat) {
            chat.modelhs.push(model);
            updateChatWindow();
            await saveChat(chat);
          }
        } else {
          alert("Failed to switch model");
        }
      } catch (error) {
        console.error("Error switching model:", error);
      }
    }
    
    async function loadInstalledModels() {
      try {
        const lang = languageSelect.value;
        const resp = await fetch("/installed-models");
        const models = await resp.json();
        modelOptionsContainer.innerHTML = "";
        modelCustomContainer.innerHTML = "";
        models.forEach(m => {
          const div = document.createElement("div");
          div.classList.add("model-option");
          div.innerHTML = `<span>${m}</span>`;
          div.addEventListener('click', () => {
            changeModel(m);
            modelModal.classList.remove('show');
            setTimeout(() => {
              modelModal.style.display = 'none';
            }, 300);
          });
          const delBtn = document.createElement("button");
          delBtn.setAttribute('title', translations[lang].deleteBtn);
          delBtn.innerHTML = `<img src="icon/delete.png" alt="${translations[lang].deleteBtn}" style="width:40px;height:40px;">`;
          delBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            await deleteModel(m);
            loadInstalledModels();
          });
          div.appendChild(delBtn);
          modelOptionsContainer.appendChild(div);
        });
        const customDiv = document.createElement("div");
        customDiv.classList.add("model-option");
        customDiv.innerHTML = `<span>${translations[lang].customModel}</span>`;
        customDiv.addEventListener('click', () => {
          if (!document.getElementById('customInput')) {
            const customInput = document.createElement("input");
            customInput.type = "text";
            customInput.placeholder = "e.g. smollm:135m";
            customInput.id = "customInput";
            customInput.classList.add("custom-input");
            const installBtn = document.createElement("button");
            installBtn.innerText = translations[lang].installModel;
            installBtn.classList.add("install-btn");
            installBtn.addEventListener("click", async () => {
              const modelName = customInput.value.trim();
              if (modelName) {
                await installModelStream(modelName);
              }
            });
            modelCustomContainer.innerHTML = "";
            modelCustomContainer.appendChild(customInput);
            modelCustomContainer.appendChild(installBtn);
          }
        });
        modelOptionsContainer.appendChild(customDiv);
      } catch (error) {
        console.error("Error loading installed models:", error);
      }
    }
    
    async function deleteModel(m) {
      try {
        const resp = await fetch("/delete-model", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: m })
        });
        const data = await resp.json();
        if (data.status !== "success") {
          alert("Failed to delete model");
        }
      } catch (error) {
        console.error("Error deleting model:", error);
      }
    }
    
    async function installModelStream(modelName) {
     isModelInstalling = true;
     currentInstallingModelName = modelName;
     globalInstallPercent = 0;

     if (sidebarProgressLabel) sidebarProgressLabel.textContent = `Installing ${modelName}...`;
     if (sidebarProgressFill) sidebarProgressFill.style.width = '0%';
     if (sidebarProgressText) sidebarProgressText.textContent = '0%';

     // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ —Ç–∞–º
     modelCustomContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å, –µ—Å–ª–∏ –±—ã–ª
     const progressContainerModal = document.createElement("div");
     progressContainerModal.className = "progress-container";
     const progressFillModal = document.createElement("div");
     progressFillModal.className = "progress-fill";
     const progressLabelModal = document.createElement("div");
     progressLabelModal.className = "progress-label";
     progressLabelModal.textContent = "0%";
     progressContainerModal.appendChild(progressFillModal);
     progressContainerModal.appendChild(progressLabelModal);
     modelCustomContainer.appendChild(progressContainerModal);
      let currentPercent = 0; // This was part of the original code, ensure it's kept if used below.
      let currentSpeed = ""; // This was part of the original code, ensure it's kept if used below.
      try {
        const resp = await fetch("/install-model-stream", {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: modelName })
        });
        const reader = await resp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let done = false;
        while (!done) {
          const { value, done: doneReading } = await reader.read();
          done = doneReading;
          if (!value) continue;
          const chunk = decoder.decode(value);
          chunk.split("\n\n").forEach(line => {
            if (line.startsWith("data: ")) {
              let dataStr = line.substring(6).trim();
              if (dataStr) {
                const percentMatch = dataStr.match(/(\d+)%/);
                if (percentMatch) {
                  currentPercent = parseInt(percentMatch[1], 10);
                  // progressFill.style.width = currentPercent + "%"; // Old modal progress
                }
                const speedMatch = dataStr.match(/(\d+(?:\.\d+)?\s*(?:MB\/s|KB\/s|GB\/s))/i);
                if (speedMatch) {
                  currentSpeed = speedMatch[1];
                }
                
                globalInstallPercent = currentPercent;
                let progressDisplayText = currentSpeed ? `${currentPercent}% | ${currentSpeed}` : `${currentPercent}%`;

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                progressFillModal.style.width = currentPercent + "%";
                progressLabelModal.textContent = progressDisplayText;

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                if (sidebarProgressFill) sidebarProgressFill.style.width = currentPercent + "%";
                if (sidebarProgressText) sidebarProgressText.textContent = progressDisplayText;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                if (modelModal.style.display === 'none' || !modelModal.classList.contains('show')) {
                  if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'block';
                } else {
                  if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'none';
                }

                if (dataStr === "DONE") {
                  progressFillModal.style.width = "100%"; // Ensure modal shows 100%
                  progressLabelModal.textContent = progressLabelModal.textContent; // Keep final text (speed might be lost here, but ok)
                  
                  if (sidebarProgressFill) sidebarProgressFill.style.width = "100%";
                  if (sidebarProgressText) sidebarProgressText.textContent = progressLabelModal.textContent; 

                  loadInstalledModels();
                  setTimeout(() => {
                    // No need to reset modal progress bar here as modelCustomContainer might be cleared or reused
                    if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'none';
                    isModelInstalling = false;
                    currentInstallingModelName = null;
                    // Reset globalInstallPercent for the next run
                    globalInstallPercent = 0; 
                  }, 2000); 
                  modelModal.classList.remove('show');
                  setTimeout(() => {
                    modelModal.style.display = 'none';
                  }, 300); // This delay should be less than the one above to hide modal first
                }
              }
            }
          });
        }
      } catch (error) {
        progressLabelModal.textContent = "Error installing model.";
        if (sidebarProgressLabel) sidebarProgressLabel.textContent = 'Error!';
        if (sidebarProgressText) sidebarProgressText.textContent = 'Failed';
        if (sidebarModelInstallProgressContainer && (modelModal.style.display === 'none' || !modelModal.classList.contains('show'))) {
           sidebarModelInstallProgressContainer.style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –∏ –Ω–∞ —Å–∞–π–¥–±–∞—Ä–µ
        }
        // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ —Å–±—Ä–æ—Å–æ–º —Ñ–ª–∞–≥–æ–≤ –∏ —Å–∫—Ä—ã—Ç–∏–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –æ—à–∏–±–∫—É
        setTimeout(() => {
           if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'none';
           isModelInstalling = false;
           currentInstallingModelName = null;
        }, 5000);
        console.error("Error installing model:", error);
      }
    }
    
    // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò ---
    function toggleTools() {
      toolsEnabled = !toolsEnabled;
      toolsBtn.classList.toggle('active', toolsEnabled);
    }

    async function executeToolCall(toolName, parameters) {
      try {
        const response = await fetch('/api/tools', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            tool: toolName,
            parameters: parameters
          })
        });

        const result = await response.json();
        return response.ok ? result.result : `–û—à–∏–±–∫–∞: ${result.error}`;
      } catch (error) {
        return `–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${error.message}`;
      }
    }

    function parseToolCalls(text) {
      const toolCallRegex = /\[TOOL_CALL\]\s*(\w+)\s*\(([^)]*)\)/g;
      const calls = [];
      let match;

      while ((match = toolCallRegex.exec(text)) !== null) {
        const toolName = match[1];
        const paramsStr = match[2].trim();
        console.log('[parseToolCalls] Original paramsStr:', paramsStr);
        
        let parameters = {};
        let attemptedJsonString = ''; // –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–∏–∑–æ—à–µ–ª —Å–±–æ–π

        try {
          if (paramsStr) {
            if (paramsStr.startsWith('{') && paramsStr.endsWith('}')) {
              // –ü–æ–ø—ã—Ç–∫–∞ 1: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ paramsStr - —ç—Ç–æ —É–∂–µ –≤–∞–ª–∏–¥–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç
              attemptedJsonString = paramsStr;
              console.log('[parseToolCalls] Attempting direct JSON.parse on (already wrapped):', attemptedJsonString);
              parameters = JSON.parse(attemptedJsonString);
            } else {
              // –ü–æ–ø—ã—Ç–∫–∞ 2: "–ö–æ—Å—Ç—ã–ª—å" –¥–ª—è —Å—Ç—Ä–æ–∫ –≤–∏–¥–∞ "–∫–ª—é—á": "–∑–Ω–∞—á–µ–Ω–∏–µ"
              // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏ –≤ paramsStr.
              let processedParams = paramsStr.replace(/\\/g, '\\\\'); // Corrected global replace
              console.log('[parseToolCalls] paramsStr after global slash escape (\\ -> \\\\):', processedParams);

              attemptedJsonString = `{${processedParams}}`;
              console.log('[parseToolCalls] Attempting JSON.parse on (wrapped and escaped):', attemptedJsonString);
              parameters = JSON.parse(attemptedJsonString);
            }
          }
          calls.push({ toolName, parameters });
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (parseToolCalls):', e.message);
          console.error('–ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (paramsStr):', paramsStr);
          console.error('–°—Ç—Ä–æ–∫–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –ø—Ä–æ–∏–∑–æ—à–µ–ª —Å–±–æ–π JSON.parse:', attemptedJsonString);
          calls.push({ toolName, parameters: {} }); 
        }
      }
      return calls;
    }

async function sendMessage() {
    const originalMsg = chatInput.value.trim();
    if (!originalMsg && imageFilesBase64.length === 0 && fileAttachments.length === 0) {
        return;
    }
    if (activeChatId === null) { // –î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —á–∞—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        console.warn("activeChatId is null in sendMessage. Attempting to create a new chat.");
        await createNewChat();
        if (activeChatId === null) {
            console.error("Failed to create or assign activeChatId. Aborting sendMessage.");
            return;
        }
    }

    const chat = chats.find(c => c.id === activeChatId);
    if (!chat) {
        console.error("Chat not found for activeChatId:", activeChatId, ". Aborting sendMessage.");
        return;
    }

    const oneLineMsg = originalMsg.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
    chatInput.value = ""; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ä–∞–∑—É
    autoResize();

    let fullText = oneLineMsg;
    if (fileAttachments.length > 0) {
        fileAttachments.forEach(file => {
            fullText += " " + file.content.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
        });
    }

    if (editingIndex !== null) {
        chat.history[editingIndex].content = fullText;
        chat.history[editingIndex].display = originalMsg;
        chat.history[editingIndex].role = "user";
        chat.history[editingIndex].images = imageFilesBase64.length > 0 ? imageFilesBase64.slice() : [];
        chat.history[editingIndex].files = fileAttachments.length > 0 
            ? fileAttachments.map(item => ({ name: item.name, content: item.content }))
            : [];
        editingIndex = null;
    } else {
        const userMessage = { role: "user", content: fullText, display: originalMsg };
        if (imageFilesBase64.length > 0) {
            userMessage.images = imageFilesBase64.slice();
        }
        if (fileAttachments.length > 0) {
            userMessage.files = fileAttachments.map(item => ({ name: item.name, content: item.content }));
        }
        chat.history.push(userMessage);
    }

    imageFilesBase64 = [];
    imageFiles = [];
    fileAttachments = [];
    updateAttachmentsPreview();
    updateChatWindow(); // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await saveChat(chat); // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // --- –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞ (–Ω–∞—á–∞–ª–æ) ---
    const nonSystemMessages = chat.history.filter(m => m.role !== 'system');
    let titleGenAttempted = false; // –§–ª–∞–≥, —á—Ç–æ –º—ã –ø—ã—Ç–∞–ª–∏—Å—å –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫

    if (nonSystemMessages.length >= 6 && !chat.titleGenerated && !isGeneratingTitle) {
        isGeneratingTitle = true;
        titleGenAttempted = true;
        const originalPlaceholder = chatInput.placeholder;
        const generatingTitleText = translations[languageSelect.value]?.inputPlaceholderGeneratingTitle || "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...";
        
        chatInput.placeholder = generatingTitleText;
        chatInput.disabled = true;
        sendBtn.disabled = true; 
        console.log('[sendMessage] UI locked for title generation.');

        try {
            const modelForTitle = (chat.modelhs && chat.modelhs.length > 0) ? chat.modelhs[chat.modelhs.length - 1] : currentModel;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ user –∏ assistant —Å–æ–æ–±—â–µ–Ω–∏—è
            const historyForTitleGeneration = chat.history.filter(m => m.role === 'user' || m.role === 'assistant');
            console.log('[sendMessage] Filtered history for title generation:', historyForTitleGeneration);

            // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ titleHandler.js –∏ –ñ–î–ï–ú –µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ–¥–∞–≤–∞—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
            const generatedTitle = await fetchGeneratedTitle(historyForTitleGeneration, modelForTitle); 

            if (generatedTitle) {
                chat.chatnamess = generatedTitle;
                chat.titleGenerated = true;
                updateChatItemText(chat); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
                if (activeChatId === chat.id) { // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç, –æ–±–Ω–æ–≤–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –≤ –æ–∫–Ω–µ —á–∞—Ç–∞
                   updateChatWindow(); 
                }
                await saveChat(chat); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ —Ñ–ª–∞–≥–æ–º
            }
        } catch (error) {
            console.error('[sendMessage] Error during title generation step (via titleHandler):', error);
        } finally {
            isGeneratingTitle = false;
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ –±—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º.
            if (chatInput.placeholder === generatingTitleText) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                 chatInput.placeholder = originalPlaceholder; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ—Ç, —á—Ç–æ –±—ã–ª –¥–æ –Ω–∞—á–∞–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            }
            // –í–∞–∂–Ω–æ: chatInput.disabled –∏ sendBtn.disabled –±—É–¥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ try/finally –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.
            // –ó–¥–µ—Å—å –∏—Ö –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–æ–Ω–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π,
            // –Ω–æ –µ—Å–ª–∏ titleGenAttempted –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –Ω–µ –Ω–∞—á–Ω–µ—Ç—Å—è, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–±—Ä–æ—à–µ–Ω—ã.
            // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –Ω–∏–∂–µ, –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Å—Ç—Ä–∏–º–∏–Ω–≥–∞.
            console.log('[sendMessage] Title generation step finished.');
        }
    } else {
        // titleGenAttempted –æ—Å—Ç–∞–Ω–µ—Ç—Å—è false, –µ—Å–ª–∏ —É—Å–ª–æ–≤–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
    }
    // --- –ö–æ–Ω–µ—Ü –ª–æ–≥–∏–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞ ---
     

    // --- –û—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ (—Å—Ç—Ä–∏–º–∏–Ω–≥) ---
    // –≠—Ç–æ—Ç –±–ª–æ–∫ —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ª–æ–≥–∏–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (–µ—Å–ª–∏ –±—ã–ª–∞) –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º UI, –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –±—ã–ª–∞ –∏ –∏–∑–º–µ–Ω–∏–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ,
    // –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–º.
    const finalPlaceholder = translations[languageSelect.value]?.inputPlaceholder || "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...";
    if (titleGenAttempted) { // –ï—Å–ª–∏ –ø—ã—Ç–∞–ª–∏—Å—å –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫, UI –º–æ–≥ –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω
        chatInput.placeholder = finalPlaceholder;
        chatInput.disabled = false; // –ë—É–¥–µ—Ç —Å–Ω–æ–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –Ω–∏–∂–µ
        sendBtn.disabled = false;   // –ë—É–¥–µ—Ç —Å–Ω–æ–≤–∞ —Å–∫—Ä—ã—Ç–∞ –Ω–∏–∂–µ
    }


    if (streamAbortController) { 
        streamAbortController.abort(); 
        console.log("[sendMessage] Aborted previous stream");
    }
    streamAbortController = new AbortController();
    
    chatInput.placeholder = finalPlaceholder; // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    sendBtn.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º Send, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Stop
    stopBtn.style.display = "inline-block";
    chatInput.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
    sendBtn.disabled = false; // Send –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–æ—Ç–æ–≤–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é (–Ω–æ –æ–Ω–∞ —Å–∫—Ä—ã—Ç–∞)

    try {
        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        let assistantMessageEntry = chat.history[chat.history.length - 1];
        if (!assistantMessageEntry || assistantMessageEntry.role !== "assistant" || assistantMessageEntry.content !== "") {
             assistantMessageEntry = {
                role: "assistant", content: "", images: [],
                modelUsed: (chat.modelhs && chat.modelhs.length > 0) ? chat.modelhs[chat.modelhs.length - 1] : currentModel
            };
            chat.history.push(assistantMessageEntry);
        } else {
            assistantMessageEntry.modelUsed = (chat.modelhs && chat.modelhs.length > 0) ? chat.modelhs[chat.modelhs.length - 1] : currentModel;
        }
        updateChatWindow(); 

        const lastMessageBlock = chatContent.querySelector('.assistant-message:last-child');
        let streamingTextContainer = null;
        if (lastMessageBlock) {
            streamingTextContainer = lastMessageBlock.querySelector('.chat-text');
            if (!streamingTextContainer) {
                streamingTextContainer = document.createElement('div');
                streamingTextContainer.className = 'chat-text';
                const buttons = lastMessageBlock.querySelector('.message-buttons');
                if (buttons) lastMessageBlock.insertBefore(streamingTextContainer, buttons);
                else lastMessageBlock.appendChild(streamingTextContainer);
            }
        } else {
            console.error("[sendMessage] Could not find lastMessageBlock for streaming.");
        }
        
        let currentStreamedContent = "";

        let messagesForStream = chat.history.slice(0, -1); // Make it let to modify

        if (toolsEnabled) {
            const toolsSystemMessage = {
                role: "system",
                content: `–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –ø–æ–ª–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
–≠—Ç–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏ —Ç–æ–ª—å–∫–æ –ø–æ –æ–¥–Ω–æ–º—É –∑–∞ —Ä–∞–∑.
–§–æ—Ä–º–∞—Ç –≤—ã–∑–æ–≤–∞: [TOOL_CALL] –∏–º—è_–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞({"–ø–∞—Ä–∞–º–µ—Ç—Ä1": "–∑–Ω–∞—á–µ–Ω–∏–µ1", "–ø–∞—Ä–∞–º–µ—Ç—Ä2": "–∑–Ω–∞—á–µ–Ω–∏–µ2"})
–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –∫–ª—é—á–µ–π –∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ JSON.
–î–ª—è –ø—É—Ç–µ–π –≤ Windows –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ª–µ—à: "C:\\Users\\User\\file.txt".

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
üìÅ –§–ê–ô–õ–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê:
- list_drives: –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –¥–∏—Å–∫–æ–≤.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –Ω–µ—Ç.
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] list_drives({})
- write_file: –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å —Ñ–∞–π–ª–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"filename": "–ø–æ–ª–Ω—ã–π_–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É", "content": "—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] write_file({"filename": "C:\\data\\new_document.txt", "content": "–≠—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞."})
- read_file: –ß—Ç–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"filename": "–ø–æ–ª–Ω—ã–π_–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] read_file({"filename": "C:\\boot.ini"})
- create_directory: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"dirname": "–ø–æ–ª–Ω—ã–π_–ø—É—Ç—å_–∫_–ø–∞–ø–∫–µ"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] create_directory({"dirname": "C:\\NewFolder"})
- list_files: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–ø–∫–∏.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"path": "–ø—É—Ç—å_–∫_–ø–∞–ø–∫–µ"} (–µ—Å–ª–∏ path –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ–∫—É—â–∏–π –∏–ª–∏ –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥)
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] list_files({"path": "D:\\Downloads"})
- delete_file: –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏ (–≤–∫–ª—é—á–∞—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏).
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"filename": "–ø–æ–ª–Ω—ã–π_–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É_–∏–ª–∏_–ø–∞–ø–∫–µ"}
- file_operations: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"operation": "copy"|"move"|"search"|"permissions", "source": "–ø—É—Ç—å_–∏—Å—Ç–æ—á–Ω–∏–∫", "destination": "–ø—É—Ç—å_–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ" (–¥–ª—è copy/move), "pattern": "—à–∞–±–ª–æ–Ω" (–¥–ª—è search)}
  –ü—Ä–∏–º–µ—Ä (–ø–æ–∏—Å–∫): [TOOL_CALL] file_operations({"operation": "search", "source": "C:\\Users", "pattern": "*.docx"})

üíª –°–ò–°–¢–ï–ú–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï:
- execute_command: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ (cmd/bash).
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"command": "–∫–æ–º–∞–Ω–¥–∞_—Å_–∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] execute_command({"command": "ipconfig /all"})
- run_application: –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"app_name": "–∏–º—è.exe"} (–¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º –∏–∑ PATH) –ò–õ–ò {"app_path": "–ø–æ–ª–Ω—ã–π_–ø—É—Ç—å_–∫\\–∏–º—è.exe"}. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å {"arguments": "–∞—Ä–≥—É–º–µ–Ω—Ç—ã"}.
  –ü—Ä–∏–º–µ—Ä (–∏–º—è): [TOOL_CALL] run_application({"app_name": "notepad.exe"})
  –ü—Ä–∏–º–µ—Ä (–ø—É—Ç—å): [TOOL_CALL] run_application({"app_path": "C:\\Program Files\\MyApp\\app.exe", "arguments": "--nogui"})
- get_system_info: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ (–û–°, CPU, GPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫–∏).
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –Ω–µ—Ç.
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] get_system_info({})
- manage_processes: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"action": "list"|"kill"|"info", "process_name": "–∏–º—è_–ø—Ä–æ—Ü–µ—Å—Å–∞" (–¥–ª—è kill/info), "process_id": id_–ø—Ä–æ—Ü–µ—Å—Å–∞ (–¥–ª—è kill/info), "force": true/false (–¥–ª—è kill, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)}
  –ü—Ä–∏–º–µ—Ä (—Å–ø–∏—Å–æ–∫): [TOOL_CALL] manage_processes({"action": "list"})
  –ü—Ä–∏–º–µ—Ä (–∑–∞–≤–µ—Ä—à–∏—Ç—å): [TOOL_CALL] manage_processes({"action": "kill", "process_name": "notepad.exe"})
  –ü—Ä–∏–º–µ—Ä (–∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ PID): [TOOL_CALL] manage_processes({"action": "kill", "process_id": 1234, "force": true})
- network_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–µ–≤—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è—Ö.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: –Ω–µ—Ç.
- manage_services: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–∞–º–∏ (Windows/Linux).
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"action": "list"|"start"|"stop"|"restart"|"status", "service_name": "–∏–º—è_—Å–ª—É–∂–±—ã"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] manage_services({"action": "status", "service_name": "spooler"})
- find_executable: –ü–æ–∏—Å–∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—É—Ç—è—Ö.
  –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {"executable_name": "–∏–º—è_—Ñ–∞–π–ª–∞.exe"}
  –ü—Ä–∏–º–µ—Ä: [TOOL_CALL] find_executable({"executable_name": "python.exe"})

–û—Ç–≤–µ—á–∞–π –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.`
            };
            // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å, –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –≤ –Ω–∞—á–∞–ª–æ
            messagesForStream = messagesForStream.filter(msg => msg.role !== 'system');
            messagesForStream.unshift(toolsSystemMessage);
        }

        const requestData = {
            model: assistantMessageEntry.modelUsed, 
            messages: messagesForStream, // messagesForStream —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å toolsSystemMessage
            tools_enabled: toolsEnabled // –û—Å—Ç–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç —Ñ–ª–∞–≥, —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –¥–æ–ø. –ª–æ–≥–∏–∫–∏, —Ö–æ—Ç—è –∫–ª–∏–µ–Ω—Ç —É–∂–µ –¥–æ–±–∞–≤–∏–ª –ø—Ä–æ–º–ø—Ç
        };
        console.log("[sendMessage] Request data for stream:", JSON.parse(JSON.stringify(requestData)));

        const resp = await fetch("/generate-stream", {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(requestData),
            signal: streamAbortController.signal
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let done = false;
        while (!done) {
            const { value, done: doneReading } = await reader.read();
            done = doneReading;
            if (!value) continue;
            const chunk = decoder.decode(value);
            chunk.split("\n\n").forEach(line => {
                if (line.startsWith("data: ")) {
                    let dataStr = line.substring(6).trim();
                    if (dataStr) {
                        dataStr = dataStr.replace(/<(?:think|thought)>[\s\S]*?<\/(?:think|thought)>/gi, "");
                        try {
                            const obj = JSON.parse(dataStr);
                            if (obj.message && obj.message.content) {
                                currentStreamedContent += obj.message.content;
                            }
                        } catch {
                            currentStreamedContent += dataStr;
                        }
                        if (streamingTextContainer) {
                            streamingTextContainer.textContent = currentStreamedContent;
                        }
                    }
                }
            });
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        assistantMessageEntry.content = currentStreamedContent; // –ü–æ–ª–Ω—ã–π —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏–∏
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º updateChatWindow() –∏ saveChat() –∑–¥–µ—Å—å —Å—Ä–∞–∑—É

        // --- –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ TOOL_CALL --- 
        if (toolsEnabled && assistantMessageEntry.content) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º assistantMessageEntry.content, –∞ –Ω–µ chat.history
            const toolCalls = parseToolCalls(assistantMessageEntry.content);
            if (toolCalls.length > 0) {
                console.log('[sendMessage] Found tool calls:', toolCalls);
                // –§–ª–∞–≥ isProcessingTools –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–¥–µ—Å—å, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                // isProcessingTools = true; 
                // chatInput.placeholder = getTranslation("processingTools"); ... etc.

                let toolResultsText = '';
                const originalContentWithToolCalls = assistantMessageEntry.content;

                for (const call of toolCalls) {
                    const result = await executeToolCall(call.toolName, call.parameters);
                    toolResultsText += `\n[TOOL_RESULT for ${call.toolName}]:\n${result}\n`; 
                }
                
                let contentWithoutToolCalls = originalContentWithToolCalls.replace(/\[TOOL_CALL\]\s*(\w+)\s*\(([^)]*)\)/g, '').trim();
                
                assistantMessageEntry.content = (contentWithoutToolCalls + toolResultsText).trim();
                console.log('[sendMessage] Content after tool processing:', assistantMessageEntry.content);
                // –ù–∏–∫–∞–∫–∏—Ö updateChatWindow() –∏–ª–∏ saveChat() –∑–¥–µ—Å—å
                // isProcessingTools = false; // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è
            }
        }
        // --- –ö–æ–Ω–µ—Ü –æ–±—Ä–∞–±–æ—Ç–∫–∏ TOOL_CALL ---

        updateChatWindow(); // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å Markdown, MathJax –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        await saveChat(chat); // –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∞—Ç–∞

    } catch (error) {
        console.error("Stream aborted or error:", error);
        if (error.name !== 'AbortError' && chat.history.length > 0) {
            const lastMessage = chat.history[chat.history.length - 1];
            if (lastMessage.role === "assistant") {
                lastMessage.content = "–û—à–∏–±–∫–∞: " + error.message;
                updateChatWindow();
                await saveChat(chat);
            }
        }
    } finally {
        sendBtn.style.display = "inline-block";
        stopBtn.style.display = "none";
        chatInput.disabled = false;
        chatInput.placeholder = finalPlaceholder; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        streamAbortController = null;
        console.log("[sendMessage] Streaming finished or aborted.");
    }
}
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–æ–Ω–æ–º
    function updateBackgroundPreview() {
      const bgType = localStorage.getItem('backgroundType');
      
      if (bgType === 'image') {
        const bgImage = localStorage.getItem('backgroundImage');
        if (bgImage) {
          bgPreview.style.backgroundImage = `url(${bgImage})`;
          bgPreviewText.textContent = '';
        }
      } else if (bgType === 'gradient') {
        const color1 = localStorage.getItem('gradientColor1') || '#4166d5';
        const color2 = localStorage.getItem('gradientColor2') || '#1e1f25';
        bgPreview.style.backgroundImage = `linear-gradient(135deg, ${color1}, ${color2})`;
        bgPreviewText.textContent = '';
      } else {
        bgPreview.style.backgroundImage = '';
        bgPreviewText.textContent = 'No background';
      }
    }
    
    function applyBackground() {
      const bgType = localStorage.getItem('backgroundType');
      const mainContent = document.querySelector('.main');
      
      if (bgType === 'image') {
        const bgImage = localStorage.getItem('backgroundImage');
        if (bgImage) {
          mainContent.style.backgroundImage = `url(${bgImage})`;
          mainContent.style.backgroundSize = 'cover';
          mainContent.style.backgroundAttachment = 'fixed';
        }
      } else if (bgType === 'gradient') {
        const color1 = localStorage.getItem('gradientColor1') || '#4166d5';
        const color2 = localStorage.getItem('gradientColor2') || '#1e1f25';
        mainContent.style.backgroundImage = `linear-gradient(135deg, ${color1}, ${color2})`;
      } else {
        mainContent.style.backgroundImage = '';
      }
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    stopBtn.addEventListener("click", () => {
      if (streamAbortController) {
        streamAbortController.abort();
      }
      sendBtn.style.display = "inline-block";
      stopBtn.style.display = "none";
    });
    
    newChatBtn.addEventListener('click', createNewChat);
    
    sendBtn.addEventListener('click', function() {
      console.log("Send button clicked!");
      sendMessage();
    });
    
    toolsBtn.addEventListener('click', toggleTools);
    
    chatInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
    
    chatInput.addEventListener('input', autoResize);
    
    changeModelBtn.addEventListener('click', () => {
      loadInstalledModels();
      if (isModelInstalling) {
        if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'none';
        // Logic to potentially update progress within modal if it's for the same model
        const customInput = document.getElementById('customInput'); // Check if custom input field exists
        const modalProgressFill = modelCustomContainer.querySelector('.progress-fill');
        const modalProgressLabel = modelCustomContainer.querySelector('.progress-label');

        if (currentInstallingModelName && modelCustomContainer.querySelector('.progress-container')) {
          // If an installation is ongoing and progress bar exists in modal
          if (modalProgressFill) modalProgressFill.style.width = globalInstallPercent + '%';
          if (modalProgressLabel) modalProgressLabel.textContent = globalInstallPercent + '%';
          // If the model being installed was from custom input, ensure input is not shown
          if (customInput && customInput.value === currentInstallingModelName) {
             // customInput.style.display = 'none'; // Or remove it
          }
        } else if (customInput) {
            // If there's a custom input but no progress for currentInstallingModelName, ensure it's clear
            // customInput.value = ''; // Or handle as needed
        }
      }
      modelModal.style.display = 'block';
      setTimeout(() => {
        modelModal.classList.add('show');
      }, 10);
    });
    
    closeModelModal.addEventListener('click', () => {
      if (isModelInstalling) {
        if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'block';
        if (sidebarProgressLabel) sidebarProgressLabel.textContent = `Installing ${currentInstallingModelName}...`;
        if (sidebarProgressFill) sidebarProgressFill.style.width = globalInstallPercent + '%';
        if (sidebarProgressText) sidebarProgressText.textContent = globalInstallPercent + '%';
      }
      modelModal.classList.remove('show');
      setTimeout(() => {
        modelModal.style.display = 'none';
      }, 300);
    });
    
    openSettingsBtn.addEventListener('click', () => {
      loadSettings();
      settingsModal.style.display = 'block';
      setTimeout(() => {
        settingsModal.classList.add('show');
      }, 10);
    });
    
    closeSettingsModal.addEventListener('click', () => {
      settingsModal.classList.remove('show');
      setTimeout(() => {
        settingsModal.style.display = 'none';
      }, 300);
    });
    
    saveSettingsBtn.addEventListener('click', saveSettings);
    

    
    window.addEventListener('click', (event) => {
      if (event.target === modelModal) {
        if (isModelInstalling) {
          if (sidebarModelInstallProgressContainer) sidebarModelInstallProgressContainer.style.display = 'block';
          if (sidebarProgressLabel) sidebarProgressLabel.textContent = `Installing ${currentInstallingModelName}...`;
          if (sidebarProgressFill) sidebarProgressFill.style.width = globalInstallPercent + '%';
          if (sidebarProgressText) sidebarProgressText.textContent = globalInstallPercent + '%';
        }
        modelModal.classList.remove('show');
        setTimeout(() => {
          modelModal.style.display = 'none';
        }, 300);
      }
      if (event.target === settingsModal) {
        settingsModal.classList.remove('show');
        setTimeout(() => {
          settingsModal.style.display = 'none';
        }, 300);
      }
    });
    
    chatWindow.addEventListener('dragenter', (e) => {
      e.preventDefault();
      dragOverlay.classList.add('active');
    });
    
    chatWindow.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    
    chatWindow.addEventListener('dragleave', (e) => {
      if (e.target === chatWindow || e.target === dragOverlay) {
        dragOverlay.classList.remove('active');
      }
    });
    
    chatWindow.addEventListener('drop', (e) => {
      e.preventDefault();
      dragOverlay.classList.remove('active');
      if (e.dataTransfer.files.length) {
        handleDroppedFiles(e.dataTransfer.files);
        handleNonImageFiles(e.dataTransfer.files);
      }
    });
    
    imageUploadBtn.addEventListener('click', () => {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', (e) => {
      const files = e.target.files;
      handleDroppedFiles(files);
      handleNonImageFiles(files);
      fileInput.value = "";
    });
    
    toggleSidebar.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      // –ù–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö:
      if (window.innerWidth <= 768) {
          if (!sidebar.classList.contains('collapsed')) {
              // –ï—Å–ª–∏ —Å–∞–π–¥–±–∞—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
              document.body.classList.add('sidebar-open-mobile'); 
              // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–ª–∏–∫–∞ –Ω–∞ .main –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∞–π–¥–±–∞—Ä–∞
          } else {
              document.body.classList.remove('sidebar-open-mobile');
          }
      }
      toggleSidebar.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–º—ã
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        currentTheme = theme; // Ensure currentTheme is updated
        applyHighlightTheme(currentTheme);
        
        document.querySelectorAll('.theme-option').forEach(opt => {
          opt.classList.remove('active');
        });
        option.classList.add('active');
      });
    });
    
    uploadBgBtn.addEventListener('click', () => {
      bgImageInput.click();
    });
    
    bgImageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          localStorage.setItem('backgroundImage', e.target.result);
          localStorage.setItem('backgroundType', 'image');
          updateBackgroundPreview();
          applyBackground();
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–æ–Ω–∞:", error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.');
        }
      };
      reader.readAsDataURL(file);
    });
    
    resetBgBtn.addEventListener('click', () => {
      localStorage.removeItem('backgroundImage');
      localStorage.removeItem('backgroundType');
      localStorage.removeItem('gradientColor1');
      localStorage.removeItem('gradientColor2');
      applyBackground();
      updateBackgroundPreview();
    });
    
    applyGradientBtn.addEventListener('click', () => {
      const color1 = gradientColor1.value;
      const color2 = gradientColor2.value;
      localStorage.setItem('gradientColor1', color1);
      localStorage.setItem('gradientColor2', color2);
      localStorage.setItem('backgroundType', 'gradient');
      updateBackgroundPreview();
      applyBackground();
    });

    if (modelTemperatureInput && modelTemperatureValueSpan) {
      modelTemperatureInput.addEventListener('input', () => {
        modelTemperatureValueSpan.textContent = parseFloat(modelTemperatureInput.value).toFixed(2);
      });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function init() {
      await loadSettings();
      await loadChats();
      
      // –ï—Å–ª–∏ –Ω–µ—Ç —á–∞—Ç–æ–≤, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
      if (chats.length === 0) {
        await createNewChat();
      } else {
        // –ï—Å–ª–∏ –µ—Å—Ç—å —á–∞—Ç—ã, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–π
        activeChatId = chats[0].id;
        switchChat(activeChatId); // <--- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨
      }
      
      updateInputPosition();
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ–Ω–∞
      applyBackground();
      
      setTimeout(() => {
        introText.style.opacity = "1";
        introText.style.transform = "translateY(0)";
      }, 300);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–∞—Ç—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
      setTimeout(() => {
        document.querySelectorAll('.chat-item').forEach(item => {
          item.classList.add('visible');
        });
      }, 500);
    }





    
    await init();
  </script>
</body>
</html>